<?xml version="1.0" encoding="windows-1252"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <!-- This gets automatically generated by the makefile running SubWCRev.exe on VersionNumberInclude.in.wxi -->
    <?include VersionNumberInclude.wxi ?>
    <?if $(env.WixPlatform) = "x64"?>
    <?define Win64YesNo = "yes" ?>
    <?define releasePath = "release64" ?>
    <?define ProfileProgramFilesFolder = "ProgramFiles64Folder" ?>
    <?endif ?>
    <?if $(env.WixPlatform) = "arm64"?>
    <?define Win64YesNo = "yes" ?>
    <?define releasePath = "releaseARM64" ?>
    <?define ProfileProgramFilesFolder = "ProgramFiles64Folder" ?>
    <?endif ?>
    <?if $(env.WixPlatform) = "x86"?>
    <?define Win64YesNo = "no" ?>
    <?define releasePath = "release" ?>
    <?define ProfileProgramFilesFolder = "ProgramFilesFolder" ?>
    <?endif?>

    <Product
      UpgradeCode="25629509-0CA5-493B-AA97-8A2B5C80EF10"
      Name="BowPad"
      Id="*"
      Language="1033"
      Codepage="1252"
      Version="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)"
      Manufacturer="Stefans Tools">

        <Package Id="*" Keywords="Installer"
              Description="BowPad Text Editor"
              Comments="http://tools.stefankueng.com" Manufacturer="Stefan's Tools"
              InstallerVersion="200" Languages="1033" Compressed="yes" SummaryCodepage="1252" Platform="$(env.WixPlatform)" />

        <Upgrade Id="25629509-0CA5-493B-AA97-8A2B5C80EF10" >
            <!-- flag is set if the install will trigger an upgrade of an existing install -->
            <UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" IncludeMaximum="no" />
        </Upgrade>

        <Media Id="1" Cabinet="BowPad.cab" EmbedCab="yes" CompressionLevel="high" />
        <Icon Id="BowPadIcon" SourceFile="..\res\BowPad.ico" />
        <Property Id="ARPPRODUCTICON">BowPadIcon</Property>
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <Property Id="RIBBONFRAMEWORK">
            <RegistrySearch Id="UIRibbon" Root="HKCR" Key="CLSID\{926749fa-2615-4987-8845-c33e65f2b957}\InProcServer32" Type="raw" />
        </Property>
        <Condition Message="This application requires the Windows Ribbon Framework to be installed.">
            Installed OR RIBBONFRAMEWORK
        </Condition>
        <?if $(env.WixPlatform) = "x64" or $(env.WixPlatform) = "arm64"?>
        <Condition Message="This application requires an 64-bit OS">VersionNT64</Condition>
        <?endif?>
        <?if $(env.WixPlatform) = "x64" or $(env.WixPlatform) = "arm64"?>
        <CustomAction Id="DefaultTargetDir" Property="INSTALLDIR" Value="[ProgramFiles64Folder]BowPad" Execute="immediate" />
        <Property Id="INSTALLDIR" Secure="yes">
            <RegistrySearch Id="PreviousInstallLocationRegistrySearchMachine" Root="HKLM" Key="Software\BowPad" Name="Directory" Type="raw" Win64="$(var.Win64YesNo)"/>
        </Property>
        <?else ?>
        <CustomAction Id="DefaultTargetDir" Property="INSTALLDIR" Value="[ProgramFilesFolder]BowPad" Execute="immediate" />
        <Property Id="INSTALLDIR" Secure="yes">
            <RegistrySearch Id="PreviousInstallLocationRegistrySearchMachine" Root="HKLM" Key="Software\BowPad" Name="Directory" Type="raw" Win64="$(var.Win64YesNo)"/>
        </Property>
        <?endif ?>

        <!-- msiexec does not have a manifest, so it always reports the version of system dlls as
         for Win7 (6.3.x.x). So we check for 6.3 but use the build number to actually check
         for Win11 -->
        <?if $(env.WixPlatform) = "x64" or $(env.WixPlatform) = "arm64"?>
        <Property Id="WIN11FOUND" Secure="yes">
            <DirectorySearch Id="searchSystem" Path="[System64Folder]" AssignToProperty="yes">
                <FileSearch Id="searchFile" Name="shell32.dll" MinVersion="6.3.21999.0"/>
            </DirectorySearch>
        </Property>
        <?endif?>

        <!-- properties for the custom actions to (un)register the sparse package -->
        <Property Id="SPARSEPACKAGEFILE" Value="package.msix"  Secure="yes"/>
        <Property Id="SPARSEPACKAGENAME" Value="2BD6356E-3263-4AA6-A5FC-C48280BE5EDD"  Secure="yes"/>

        <Binary Id="CustomActions.dll"  SourceFile="../../bin/release/bin/CustomActions.dll" />
        <CustomAction Id="RegisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="RegisterSparsePackage"/>
        <CustomAction Id="UnregisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="UnregisterSparsePackage"/>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.ProfileProgramFilesFolder)" Name="PFiles">
                <Directory Id="INSTALLDIR" Name="BowPad">

                    <Component Id="BowPad.exe" Guid="666BFAE6-68D2-4F4E-A579-32CDDDA0BA74" Win64="$(var.Win64YesNo)">
                        <File Id="BowPad.EXE" Name="BowPad.exe" DiskId="1" Source="../../bin/$(var.releasePath)/bin/BowPad.exe" Vital="yes" />
                        <?if $(env.WixPlatform) = "x64" or $(env.WixPlatform) = "arm64"?>
                        <File Id="package.msix" Name="package.msix" DiskId="1" Source="../../bin/$(var.releasePath)/bin/package.msix" Vital="yes" />
                        <File Id="shelldll" Name="ExplorerCommandVerb.dll" DiskId="1" Source="../../bin/$(var.releasePath)/bin/ExplorerCommandVerb.dll" Vital="yes" />
                        <?endif?>
                    </Component>
                    <Component Id="BowPadShellMenu" Guid="43123CE3-4D2C-4200-BB10-C128EFC6F486" Win64="$(var.Win64YesNo)">
                        <RegistryValue Root="HKLM" Key="Software\Classes\*\shell\BowPad" Value='Edit with BowPad' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\*\shell\BowPad" Name="Icon" Value='[INSTALLDIR]BowPad.exe,-107' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\*\shell\BowPad" Name="MultiSelectModel" Value='Player' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\*\shell\BowPad\command" Value='"[INSTALLDIR]BowPad.exe" /path:"%1"' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\shell\BowPad" Value='Open Folder with BowPad' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\shell\BowPad" Name="Icon" Value='[INSTALLDIR]BowPad.exe,-107' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\shell\BowPad\command" Value='"[INSTALLDIR]BowPad.exe" /path:"%1"' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\Background\shell\BowPad" Value='Open Folder with BowPad' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\Background\shell\BowPad" Name="Icon" Value='[INSTALLDIR]BowPad.exe,-107' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\Directory\Background\shell\BowPad\command" Value='"[INSTALLDIR]BowPad.exe" /path:"%V"' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\BowPad" Name="installDir" Value='[INSTALLDIR]' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\*\OpenWithProgids" Name="BowPad.file" Value="" Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\BowPad.file" Name="AppUserModelID" Value='TortoiseSVN.Tools.BowPad.1' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\BowPad.file\DefaultIcon" Value='[INSTALLDIR]BowPad.exe,-155' Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Classes\BowPad.file\shell\BowPad\command" Value='"[INSTALLDIR]BowPad.exe" /path:"%1"' Type="string" />
                        <RegistryKey Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\BowPad.exe" />
                        <RegistryValue Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\BowPad.exe" Name="Path" Value="[INSTALLDIR]" Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\BowPad.exe" Value="[INSTALLDIR]BowPad.exe" Type="string" />

                        <RegistryValue Root="HKLM" Key="Software\Microsoft\Active Setup\Installed Components\[UpgradeCode]" Name="Version" Value="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" Type="string" KeyPath="yes" />
                        <RegistryValue Root="HKLM" Key="Software\Microsoft\Active Setup\Installed Components\[UpgradeCode]" Name="Stubpath" Value="[INSTALLDIR]BowPad.exe /registerwin11contextmenu" Type="string" />
                        <RegistryValue Root="HKLM" Key="Software\Microsoft\Active Setup\Installed Components\[UpgradeCode]" Value="[ProductName]" Type="string" />
                    </Component>

                </Directory>
                <Directory Id="ProgramMenuFolder" Name="Programs">
                    <Directory Id="ProgramMenuDir" Name="BowPad" />
                </Directory>
            </Directory>

        </Directory>
        <DirectoryRef Id="ProgramMenuDir">
            <Component Id="StartMenuShortCut" Guid="64827EDD-A357-488F-8687-AC7740FF698A" Win64="$(var.Win64YesNo)">
                <Shortcut Id="startMenuBowPad" Directory="ProgramMenuDir" Name="BowPad" Target="[INSTALLDIR]BowPad.exe" Description="A Text Editor with a ribbon UI" />
                <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
                <RegistryValue Root="HKCU" Key="Software\BowPad" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                <IniFile Id="WebsiteUrl" Action="addLine" Name="Website.url" Directory="INSTALLDIR" Section="InternetShortcut" Key="URL" Value="http://tools.stefankueng.com" />
                <Shortcut Id="WebsiteUrlShortCut" Directory="ProgramMenuDir" Name="Website" Target="[INSTALLDIR]Website.url" Description="Visit BowPad's Website" />
            </Component>
        </DirectoryRef>

        <Feature Id="Complete" Title="BowPad (64-bit)" Description="The complete package."
              Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">
            <Feature Id="MainEXE" Title="Program" Description="The main executable." Level="1">
                <ComponentRef Id="BowPad.exe" />
                <ComponentRef Id="BowPadShellMenu" />
                <ComponentRef Id="StartMenuShortCut" />
            </Feature>
        </Feature>

        <UI>
            <UIRef Id="WixUI_InstallDir" />
            <!-- skip licence dialog -->
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>

            <Publish Dialog="ExitDialog"
                        Control="Finish"
                        Event="DoAction"
                        Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>
        <WixVariable Id="WixUIBannerBmp" Value="Banner.jpg" />
        <WixVariable Id="WixUIDialogBmp" Value="Dialog.jpg" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch BowPad" />
        <Property Id="WixShellExecTarget" Value="[#BowPad.EXE]" />
        <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

        <InstallExecuteSequence>
            <AppSearch Sequence="1"></AppSearch>
            <LaunchConditions After="AppSearch" />
            <RemoveExistingProducts After="InstallFinalize"><![CDATA[PREVIOUSVERSIONSINSTALLED]]></RemoveExistingProducts>
            <?if $(env.WixPlatform) = "x64" or $(env.WixPlatform) = "arm64"?>
            <Custom Action="RegisterSparsePackage" After="InstallFinalize">NOT (REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
            <Custom Action="UnregisterSparsePackage" Before="RemoveFiles">(REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
            <?endif?>
        </InstallExecuteSequence>

    </Product>
</Wix>
